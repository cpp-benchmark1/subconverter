name: Coverity Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  coverity-scan:
    runs-on: windows-latest
    permissions:
      security-events: write
      contents: read
      actions: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.3

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: base-devel git mingw-w64-x86_64-gcc mingw-w64-x86_64-cmake mingw-w64-x86_64-curl mingw-w64-x86_64-rapidjson mingw-w64-x86_64-yaml-cpp mingw-w64-x86_64-pcre2 mingw-w64-x86_64-libxml2
        path-type: inherit

    - name: Download Coverity Build Tool
      shell: powershell
      run: |
        $form = @{
          token = "${{ secrets.COVERITY_TOKEN }}"
          project = "${{ github.repository }}"
        }
        Invoke-WebRequest -Uri "https://scan.coverity.com/download/cxx/win64" -Method POST -Body $form -OutFile "coverity_tool.zip"
        Expand-Archive -Path "coverity_tool.zip" -DestinationPath "coverity-tools"

    - name: Configure CMake
      shell: msys2 {0}
      run: |
        cmake -B build -S . \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_STATIC_LIBRARY=OFF

    - name: Build with Coverity
      shell: msys2 {0}
      run: |
        export PATH="$PWD/coverity-tools/bin:$PATH"
        cd build
        cov-build --dir cov-int cmake --build . --config Release

    - name: Submit to Coverity Scan
      shell: powershell
      run: |
        cd build
        Compress-Archive -Path "cov-int" -DestinationPath "myproject.zip"
        $form = @{
          token = "${{ secrets.COVERITY_TOKEN }}"
          email = "cpp.benchmark@proton.me"
          version = "${{ github.ref_name }}"
          description = "GitHub Actions build"
        }
        $fileBytes = [System.IO.File]::ReadAllBytes("myproject.zip")
        $boundary = [System.Guid]::NewGuid().ToString()
        $LF = "`r`n"
        $bodyLines = @(
          "--$boundary",
          "Content-Disposition: form-data; name=`"token`"$LF",
          $form.token,
          "--$boundary",
          "Content-Disposition: form-data; name=`"email`"$LF", 
          $form.email,
          "--$boundary",
          "Content-Disposition: form-data; name=`"version`"$LF",
          $form.version,
          "--$boundary", 
          "Content-Disposition: form-data; name=`"description`"$LF",
          $form.description,
          "--$boundary",
          "Content-Disposition: form-data; name=`"file`"; filename=`"myproject.zip`"",
          "Content-Type: application/zip$LF"
        )
        $bodyString = $bodyLines -join $LF
        $bodyBytes = [System.Text.Encoding]::UTF8.GetBytes($bodyString)
        $endBytes = [System.Text.Encoding]::UTF8.GetBytes("$LF--$boundary--$LF")
        $fullBody = $bodyBytes + $fileBytes + $endBytes
        Invoke-RestMethod -Uri "https://scan.coverity.com/builds?project=${{ github.repository }}" -Method Post -Body $fullBody -ContentType "multipart/form-data; boundary=$boundary"

    - name: Upload Coverity Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverity-results
        path: build/cov-int/
        retention-days: 7