on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  coverity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake git pkg-config \
          libcurl4-openssl-dev libpcre2-dev libyaml-cpp-dev libxml2-dev \
          liblzma-dev bzip2

      - name: Install LibCron
        run: |
          git clone https://github.com/PerMalmberg/libcron.git
          cd libcron
          mkdir build && cd build
          cmake ..
          make -j$(nproc)
          sudo make install
          cd ../..

      - name: Download Coverity
        run: |
          wget https://scan.coverity.com/download/linux64 \
            --post-data "token=${{ secrets.COVERITY_TOKEN }}&project=${{ github.repository }}" \
            -O coverity_tool.tgz
          mkdir cov-analysis
          tar xzf coverity_tool.tgz --strip-components=1 -C cov-analysis
          export PATH=$PWD/cov-analysis/bin:$PATH

      - name: Configure and Capture Build
        run: |
          mkdir -p build
          cd build
          cov-build --dir ../cov-int cmake .. -DCMAKE_BUILD_TYPE=Release
          cov-build --dir ../cov-int make -j$(nproc)
          cd ..

      - name: Analyze
        run: |
          cov-analyze --dir cov-int

      - name: Submit to Coverity
        run: |
          cov-commit-defects \
            --dir cov-int \
            --url https://scan.coverity.com \
            --stream ${{ github.repository }} \
            --user ${{ secrets.COVERITY_TOKEN }}
