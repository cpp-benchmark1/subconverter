name: Coverity Scan
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      languages:
        description: "Languages to analyze"
        required: true
        default: "c-cpp"

jobs:
  coverity:
    runs-on: windows-latest
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
        - language: c-cpp
          build-mode: manual

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Download and Install Coverity Tool
        shell: powershell
        run: |
          $zipPath = "coverity_tool.zip"
          $form = @{
            token = "${{ secrets.COVERITY_TOKEN }}"
            project = "${{ github.repository }}"
          }
          $headers = @{
            "User-Agent" = "GitHubActions-Coverity"
          }

          Write-Output "⬇️ Downloading Coverity tool..."
          try {
            Invoke-WebRequest -Uri "https://scan.coverity.com/download/win64" `
              -Method Post `
              -Headers $headers `
              -ContentType "application/x-www-form-urlencoded" `
              -Body $form `
              -OutFile $zipPath -UseBasicParsing
          } catch {
            Write-Error "❌ Failed to download Coverity tool: $($_.Exception.Message)"
            exit 1
          }

          if (-not (Test-Path $zipPath)) {
            Write-Error "❌ Coverity zip not found after download!"
            exit 1
          }

          New-Item -ItemType Directory -Path "coverity_tool" -Force | Out-Null
          Expand-Archive $zipPath -DestinationPath "coverity_tool" -Force
          $Env:PATH = "$PWD\coverity_tool\bin;$Env:PATH"
          New-Item -ItemType Directory -Path "cov-int" -Force | Out-Null
          Write-Output "✅ Coverity Tool installed successfully"
          Get-ChildItem -Recurse coverity_tool

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: base-devel git mingw-w64-x86_64-gcc mingw-w64-x86_64-cmake mingw-w64-x86_64-pcre2 mingw-w64-x86_64-libxml2 patch
          path-type: inherit

      - name: Build with Coverity
        shell: msys2 {0}
        run: |
          covFolder=$(find coverity_tool -type d -name 'cov-analysis-win64*' | head -n1)
          if [ -z "$covFolder" ]; then
            echo "❌ Could not find the cov-analysis-win64 folder inside coverity_tool"
            exit 1
          fi
          covPath="$covFolder/bin/cov-build.exe"
          echo "✅ Using Coverity at: $covPath"
          SHA=$(git rev-parse --short HEAD)
          sed -i 's/\(v[0-9]\.[0-9]\.[0-9]\)/\1-'"$SHA"'/' src/version.h
          echo "Listing structure under coverity_tool (max 3 levels):"
          find coverity_tool -type d -maxdepth 3 || true
          echo "Listing top-level directories:"
          ls -1 || true
          "$covPath" --dir cov-int bash -lc "./scripts/build.windows.release.sh VERBOSE=1"
      - name: Verify Coverity output
        shell: msys2 {0}
        run: |
          if [ -f "cov-int/build-log.txt" ]; then
            echo "✅ build-log.txt found"
          elif [ -f "cov-int/output/cli-diagnostics.json" ]; then
            echo "✅ cli-diagnostics.json found"
          else
            echo "❌ No Coverity output found!"
            echo "Listing cov-int contents:"
            ls -R cov-int || true
            exit 1
          fi
      - name: Compress Results
        shell: powershell
        run: |
          Compress-Archive -Path cov-int -DestinationPath myproject.zip
        id: compress

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "coverity-scan-${{ github.run_id }}"
          release_name: "Coverity Scan Results"
          body: "Automated Coverity Scan Results"
          draft: false
          prerelease: false

      - name: Upload Asset to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: myproject.zip
          asset_name: myproject.zip
          asset_content_type: application/x-bzip2

      - name: Notify Coverity Scan
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://scan.coverity.com/builds" -Method Post -Body @{
            project     = "${{ github.repository }}"
            token       = "${{ secrets.COVERITY_TOKEN }}"
            email       = "cpp.benchmark@proton.me"
            url         = "https://github.com/${{ github.repository }}/releases/download/coverity-scan-${{ github.run_id }}/myproject.zip"
            version     = "1.0"
            description = "Automated Coverity Scan"
          }